### –ü–æ–¥—Ä–æ–±–Ω–æ –æ **`AuthorizationManager`** –≤ Spring Security

**`AuthorizationManager`** ‚Äî —ç—Ç–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç Spring Security, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ **–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é**. –û–Ω –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∏–º–µ–µ—Ç –ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ—Å—Ç—É–ø –∫ —Ä–µ—Å—É—Ä—Å—É –∏–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –µ–≥–æ —Ä–æ–ª—è—Ö, –ø–æ–ª–Ω–æ–º–æ—á–∏—è—Ö –∏ –¥—Ä—É–≥–∏—Ö –∞—Ç—Ä–∏–±—É—Ç–∞—Ö –∑–∞–ø—Ä–æ—Å–∞.

---

### **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `AuthorizationManager`?**

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è **–ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞** –Ω–∞ —É—Ä–æ–≤–Ω–µ –∑–∞–ø—Ä–æ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, REST API).
- –Ø–≤–ª—è–µ—Ç—Å—è –≥–∏–±–∫–æ–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–æ–π –∞–Ω–Ω–æ—Ç–∞—Ü–∏—è–º `@PreAuthorize`, `@Secured` –∏–ª–∏ `hasRole`.
- –ü–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —Å —É—á–µ—Ç–æ–º –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –∑–∞–ø—Ä–æ—Å–∞, —Ç–∞–∫–∏—Ö –∫–∞–∫:
  - –ü—É—Ç—å (`/users/{id}`)
  - –ú–µ—Ç–æ–¥ HTTP (`GET`, `POST`)
  - –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–∏–∑ `Authentication`).

---

### **–û—Å–Ω–æ–≤–Ω–∞—è —Ä–æ–ª—å `AuthorizationManager`**
1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –¥–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â–µ–Ω–Ω–æ–º—É —Ä–µ—Å—É—Ä—Å—É.
2. –†–∞–±–æ—Ç–∞–µ—Ç **–ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** ‚Äî —Ç–æ –µ—Å—Ç—å, –∫–æ–≥–¥–∞ –æ–±—ä–µ–∫—Ç `Authentication` —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ `SecurityContext`.
3. –í–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å –ø–æ—Ç–æ–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—É.

---

### **–ì–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è `AuthorizationManager` –≤ –ø–æ—Ç–æ–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞?**

1. **–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:**
   - –ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ —Ç–æ–∫–µ–Ω –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ `BearerTokenAuthenticationFilter`), —Å–æ–∑–¥–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç `Authentication`, –∏ –æ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `SecurityContext`.

2. **–ü–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞:**
   - `AuthorizationManager` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.
   - –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.
   - –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –∑–∞–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π `403 Forbidden`.

---

### **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç `AuthorizationManager`?**

1. **`AuthorizationManager` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:**
   - Spring Security –≤—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥ `check` —É –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ `AuthorizationManager` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞.
   - –ú–µ—Ç–æ–¥ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç:
     - **`Authentication`** ‚Äî —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤–∑—è—Ç–æ –∏–∑ `SecurityContext`).
     - **`RequestAuthorizationContext`** ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, URI, –º–µ—Ç–æ–¥ HTTP).

2. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞:**
   - –ü—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —É—Å–ª–æ–≤–∏—è –¥–æ—Å—Ç—É–ø–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
     - –†–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`ROLE_USER`, `ROLE_ADMIN`).
     - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –ø—É—Ç–∏ (`/users/{id}`).
     - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–∏–º –¥–∞–Ω–Ω—ã–º).

3. **–í–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ —Ä–µ—à–µ–Ω–∏—è:**
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç `AuthorizationDecision`, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:
     - `true` ‚Äî –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω.
     - `false` ‚Äî –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.

4. **–î–∞–ª—å–Ω–µ–π—à–∏–π –ø–æ—Ç–æ–∫:**
   - –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω, –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.
   - –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω, –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `AccessDeniedException`.

---

### **–ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã `AuthorizationManager`**

1. **`check(Supplier<Authentication> authentication, Object object)`**
   - –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç, —Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –¥–æ—Å—Ç—É–ø –∫ —Ä–µ—Å—É—Ä—Å—É.
   - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç:
     - `authentication` ‚Äî —Ç–µ–∫—É—â–∏–π –æ–±—ä–µ–∫—Ç `Authentication` (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–æ–∫–µ–Ω JWT).
     - `object` ‚Äî –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `RequestAuthorizationContext`).
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
     - `AuthorizationDecision`.

2. **`AuthorizationDecision`**
   - –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:
     - `true` ‚Äî –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω.
     - `false` ‚Äî –¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.

---

### **–ü—Ä–∏–º–µ—Ä —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ `AuthorizationManager`**

#### **–ö–æ–¥ `AuthorizationManager`**
```java
@Component
public class UserRequestAuthorizationManager implements AuthorizationManager<RequestAuthorizationContext> {
    private static final UriTemplate USER_URI_TEMPLATE = new UriTemplate("/users/{userId}");

    @Override
    public AuthorizationDecision check(Supplier<Authentication> authenticationSupplier, RequestAuthorizationContext context) {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –ø—É—Ç—å –∏–∑ URI
        Map<String, String> uriVariables = USER_URI_TEMPLATE.match(context.getRequest().getRequestURI());
        String userIdFromRequestUri = uriVariables.get("userId");

        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
        Authentication authentication = authenticationSupplier.get();
        String userIdFromJwt = ((Jwt) authentication.getPrincipal()).getClaim("userId").toString();

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π
        boolean hasUserRole = authentication.getAuthorities().stream()
                .anyMatch(grantedAuthority -> grantedAuthority.getAuthority().equals("ROLE_user"));
        boolean hasAdminRole = authentication.getAuthorities().stream()
                .anyMatch(grantedAuthority -> grantedAuthority.getAuthority().equals("ROLE_admin"));

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è userId
        boolean userIdsMatch = userIdFromRequestUri != null && userIdFromRequestUri.equals(userIdFromJwt);

        // –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        return new AuthorizationDecision(hasAdminRole || (hasUserRole && userIdsMatch));
    }
}
```

#### **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–æ–ª—å `ROLE_admin`, –æ–Ω –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ä–µ—Å—É—Ä—Å–∞–º.
- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ä–æ–ª—å `ROLE_user`, –æ–Ω –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–∏–º —Ä–µ—Å—É—Ä—Å–∞–º (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ `userId`).

---

### **–ü—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Security —Å `AuthorizationManager`**

#### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Spring Security:
```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity http, UserRequestAuthorizationManager authorizationManager) throws Exception {
    return http
        .authorizeHttpRequests(authorize -> authorize
            .requestMatchers(HttpMethod.GET, "/users/**")
                .access(authorizationManager) // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π AuthorizationManager
            .anyRequest()
                .authenticated()
        )
        .httpBasic(Customizer.withDefaults())
        .csrf(csrf -> csrf.disable())
        .build();
}
```

---

### **–ü–æ—Ç–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å `AuthorizationManager`**

1. **HTTP-–∑–∞–ø—Ä–æ—Å –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:**
   - –ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:
     ```http
     GET /users/123 HTTP/1.1
     Authorization: Bearer <token>
     ```

2. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è:**
   - –ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ `BearerTokenAuthenticationFilter`.
   - –¢–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –∞ –æ–±—ä–µ–∫—Ç `Authentication` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `SecurityContext`.

3. **–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è:**
   - `AuthorizationManager` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞.
   - –ü—Ä–∏–º–µ—Ä –ª–æ–≥–∏–∫–∏:
     - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (`ROLE_admin`), –¥–æ—Å—Ç—É–ø —Ä–∞–∑—Ä–µ—à–µ–Ω.
     - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (`ROLE_user`), –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ `userId`.

4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –∑–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.
   - –ï—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞ `403 Forbidden`.

---

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ `AuthorizationManager`**

1. **–ì–∏–±–∫–æ—Å—Ç—å:**
   - –ü–æ–∑–≤–æ–ª—è–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
   - –ú–æ–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å –∫–∞–∫ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–∞–∫ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `userId`).

2. **–£–¥–æ–±–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
   - –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Spring Security —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ `access()`.

3. **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å:**
   - –ö–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ª–µ–≥–∫–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å.

---

### –ò—Ç–æ–≥

- **`AuthorizationManager`** ‚Äî —ç—Ç–æ –º–æ—â–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –¥–ª—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Spring Security.
- –û–Ω –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è **–ø–æ—Å–ª–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏**, —á—Ç–æ–±—ã —Ä–µ—à–∏—Ç—å, —Ä–∞–∑—Ä–µ—à–µ–Ω –ª–∏ –¥–æ—Å—Ç—É–ø.
- –ï–≥–æ –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–æ–ª–µ–π, –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∑–∞–ø—Ä–æ—Å–∞ –∏ –¥—Ä—É–≥–∏—Ö –∞—Ç—Ä–∏–±—É—Ç–æ–≤.

–ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–º–µ—Ä –∏–ª–∏ —É—Ç–æ—á–Ω–µ–Ω–∏–µ, –¥–∞–π—Ç–µ –∑–Ω–∞—Ç—å! üòä